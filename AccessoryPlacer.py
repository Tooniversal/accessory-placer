HatModels = [None,
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_baseball',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_safari',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_ribbon',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_heart',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_topHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_anvil',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_flowerPot',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_sandbag',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_weight',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_fez',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_golfHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_partyHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_pillBox',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_crown',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_cowboyHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_pirateHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_propellerHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_fishingHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_sombreroHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_strawHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_sunHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_antenna',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_beeHiveHairdo',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_bowler',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_chefsHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_detective',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_feathers',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_fedora',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_mickeysBandConductorHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_nativeAmericanFeather',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_pompadorHairdo',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_princess',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_robinHoodHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_romanHelmet',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_spiderAntennaThingy',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_tiara',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_vikingHelmet',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_witch',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_wizard',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_conquistadorHelmet',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_firefighterHelmet',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_foilPyramid',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_minersHardhatWithLight',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_napoleonHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_pilotsCap',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_policeHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_rainbowAfroWig',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_sailorHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_carmenMirandaFruitHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_bobbyHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_jugheadHat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_winter',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_bandana',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_dinosaur',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_band',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_birdNest',
 'phase_4/models/accessories/tt_m_chr_avt_acc_hat_mousekateer',
 'phase_4/models/accessories/tvs_m_chr_avt_acc_hat_hatBow'
]
HatTextures = [None,
 'phase_4/maps/tt_t_chr_avt_acc_hat_ribbonRed.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_ribbonPurple.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_heartYellow.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_topHatBlue.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_safariBrown.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_safariGreen.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_baseballBlue.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_baseballOrange.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_ribbonYellow.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_ribbonChecker.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_ribbonLtRed.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_ribbonRainbow.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_baseballYellow.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_baseballRed.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_baseballTeal.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_ribbonPinkDots.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_baseballPurple.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_ribbonCheckerGreen.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_partyToon.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_hat_bowlerRoger.jpg',
 'phase_4/maps/tt_m_chr_avt_acc_hat_mousekateer.jpg',
 'phase_4/maps/stPatricksHat.png',
 'phase_4/maps/apparel/holiday/easter/tvs_holiday_easterAcc_BowBlue.png',
 'phase_4/maps/apparel/holiday/easter/tvs_holiday_easterAcc_BowPink.png'
]
GlassesModels = [None,
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_roundGlasses',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_miniblinds',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_narrowGlasses',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_starGlasses',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_3dGlasses',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_aviator',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_catEyeGlasses',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_dorkGlasses',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_jackieOShades',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_scubaMask',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_goggles',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_grouchoMarxEyebrow',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_heartGlasses',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_insectEyeGlasses',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_masqueradeTypeMask',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_masqueradeTypeMask3',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_monocle',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_mouthGlasses',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_squareRims',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_eyepatch',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_alienGlasses',
 'phase_4/models/accessories/tt_m_chr_avt_acc_msk_hypno_goggles17',
 'phase_4/models/accessories/tvs_m_chr_avt_acc_msk_roseGlasses'
]
GlassesTextures = [None,
 'phase_4/maps/tt_t_chr_avt_acc_msk_masqueradeTypeMask2.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_msk_masqueradeTypeMask4.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_msk_masqueradeTypeMask5.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_msk_eyepatchGems.jpg'
]
BackpackModels = [None,
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_backpack',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_batWings',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_beeWings',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_dragonFlyWings',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_scubaTank',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_sharkFin',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_angelWings',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_backpackWithToys',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_butterflyWings',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_dragonWing',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_jetPack',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_spiderLegs',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_stuffedAnimalBackpackA',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_birdWings',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_stuffedAnimalBackpackCat',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_stuffedAnimalBackpackDog',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_airplane',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_woodenSword',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_supertoonCape',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_vampireCape',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_dinosaurTail',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_band',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_gags',
 'phase_4/models/accessories/tt_m_chr_avt_acc_pac_flunky',
 'phase_4/models/accessories/tvs_m_chr_avt_acc_pac_backpackChocolate',
 'phase_4/models/accessories/tvs_m_chr_avt_acc_pac_backpackClock'
]
BackpackTextures = [None,
 'phase_4/maps/tt_t_chr_avt_acc_pac_backpackOrange.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_pac_backpackPurple.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_pac_backpackPolkaDotRed.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_pac_backpackPolkaDotYellow.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_pac_angelWingsMultiColor.jpg',
 'phase_4/maps/tt_t_chr_avt_acc_pac_butterflyWingsStyle2.jpg'
]

 
HeadBaseDir = 'phase_3'
TorsoBaseDir = 'phase_3'

HeadDict = {
    'dsl': '/models/char/tt_a_chr_dgm_shorts_head_1000', # Unused in Placer
    'ds': '/models/char/tt_a_chr_dgm_skirt_head_1000',
    'dls': '/models/char/tt_a_chr_dgs_shorts_head_1000', # Unused in Placer
    'dl': '/models/char/tt_a_chr_dgl_shorts_head_1000',
    'c': '/models/char/cat-heads-1000',
    'h': '/models/char/horse-heads-1000',
    'm': '/models/char/mouse-heads-1000',
    'r': '/models/char/rabbit-heads-1000',
    'f': '/models/char/duck-heads-1000',
    'p': '/models/char/monkey-heads-1000',
    'b': '/models/char/bear-heads-1000',
    's': '/models/char/pig-heads-1000',
    'u': '/models/char/hedgehog-heads-1000',
    'k': '/models/char/kangaroo-heads-1000',
    'e': '/models/char/deer-heads-1000'
}

HeadSizes = [
    'es',
    'el',
    'us',
    'ul',
    'ks',
    'kl',
    'dl',
    'ds',
    'cs',
    'cl',
    'ms',
    'ml',
    'rs',
    'rl',
    'fs',
    'fl',
    'ps',
    'pl',
    'bs',
    'bl',
    'ss',
    'sl',
]

TorsoDict = {
    'ss': '/models/char/tt_a_chr_dgs_shorts_torso_1000',
    'ms': '/models/char/tt_a_chr_dgm_shorts_torso_1000',
    'ls': '/models/char/tt_a_chr_dgl_shorts_torso_1000',
    'sd': '/models/char/tt_a_chr_dgs_skirt_torso_1000',
    'md': '/models/char/tt_a_chr_dgm_skirt_torso_1000',
    'ld': '/models/char/tt_a_chr_dgl_skirt_torso_1000'
}

LegDict = {
    's': '/models/char/tt_a_chr_dgs_shorts_legs_1000',
    'm': '/models/char/tt_a_chr_dgm_shorts_legs_1000',
    'l': '/models/char/tt_a_chr_dgl_shorts_legs_1000'
}

TorsoTypes = ['ss',
 'ms',
 'ls',
 'sd',
 'md',
 'ld',
]

TorsoSizes = ['s', 'm', 'l']

LegTypes = ['s', 'm', 'l']

from direct.showbase.ShowBase import ShowBase
from panda3d.core import loadPrcFileData
import json

class AccessoryPlacer(ShowBase):
 
    def __init__(self):
        ShowBase.__init__(self)
 
base = AccessoryPlacer()

loadPrcFileData('', 'default-model-extension .bam')
loadPrcFileData('', 'model-path ../resources')

with open('accessories.json', 'r') as f:
    data = json.load(f)

currHead = None
currHeadIndex = 0
currTorso = None
currTorsoIndex = 0
currLegs = None
currLegsIndex = 0
currBackpack = None
currBackpackIndex = 0
currHat = None
currHatIndex = 0
currGlasses = None
currGlassesIndex = 0
currBackpackPlacer = None
currHatPlacer = None
currGlassesPlacer = None

def loadHead():
    global currHead, currHeadIndex
    headSize = HeadSizes[currHeadIndex]
    species, size = headSize
    if species == 'd':
        species = species + size
        currHead = loader.loadModel(HeadBaseDir + HeadDict[species])
        showDogHead(currHead)
        currHead.reparentTo(render)
        return
    currHead = loader.loadModel(HeadBaseDir + HeadDict[species])
    if size == 'l':
        showLongHead(currHead)
    elif size == 's':
        showShortHead(currHead)

    currHead.reparentTo(render)
    
def unloadHead():
    global currHead
    currHead.removeNode()
    
def changeHead(offset):
    global currTorso, currHeadIndex
    currHeadIndex += offset
    
    if currHeadIndex >= len(HeadSizes):
        currHeadIndex = 0
    elif currHeadIndex <= -1:
        currHeadIndex = len(HeadSizes) - 1
    
    unloadHead()
    if currTorso is not None:
        unloadBackpack()
        unloadTorso()
    loadHead()
    loadHat()
    loadGlasses()
    
def loadTorso():
    global currTorso, currTorsoIndex
    size = TorsoSizes[currTorsoIndex]
    currTorso = loader.loadModel(TorsoBaseDir + TorsoDict[size + 's'])
    showTorso(currTorso)
    currTorso.setH(currTorso.getH() + 180)
    currTorso.reparentTo(render)

def unloadTorso():
    global currTorso
    if not currTorso:
        return
    currTorso.removeNode()
    currTorso = None

def changeTorso(offset):
    global currHead, currTorsoIndex
    currTorsoIndex += offset
    
    if currTorsoIndex >= len(TorsoSizes):
        currTorsoIndex = 0
    elif currTorsoIndex <= -1:
        currTorsoIndex = len(TorsoSizes) - 1
    
    unloadBackpack()
    unloadTorso()
    if currHead is not None:
        unloadHead()
        unloadHat()
        unloadGlasses()
    loadTorso()
    loadBackpack()
    
def loadBackpack():
    global currTorsoIndex, currBackpackIndex, currBackpack, backpackLabel
    torsoSize = TorsoSizes[currTorsoIndex]
    print('loadBackpack', currBackpackIndex)
    if currBackpackIndex == 0:
        backpackLabel['text'] = 'Backpack: None'
        return
    modelName = BackpackModels[currBackpackIndex]
    backpackLabel['text'] = 'Backpack: ' + modelName
    currBackpack = loader.loadModel(modelName)
    try:
        pos, hpr, scale = data['backpacks']['specific'][str(currBackpackIndex)][torsoSize]
        print(pos, hpr, scale)
        currBackpack.setPos(*pos)
        currBackpack.setHpr(*hpr)
        currBackpack.setScale(*scale)
    except KeyError:
        try:
            pos, hpr, scale = data['backpacks']['defaults'][torsoSize]
            print(pos, hpr, scale)
            currBackpack.setPos(*pos)
            currBackpack.setHpr(*hpr)
            currBackpack.setScale(*scale)
        except KeyError:
            pass
    attachBackpack()

def attachBackpack():
    global currBackpack, currTorso
    nodes = currTorso.findAllMatches('**/def_joint_attachFlower')
    backpackNode = nodes[0].attachNewNode('backpackNode')
    currBackpack.reparentTo(backpackNode)

def changeBackpack(offset):
    global currBackpack, currBackpackIndex, currHatPlacer
    currBackpackIndex += offset
    
    if currBackpackIndex >= len(BackpackModels):
        currBackpackIndex = 0
    elif currBackpackIndex <= -1:
        currBackpackIndex = len(BackpackModels) - 1
    
    unloadBackpack()
    if currHead and not currHead.isEmpty():
        unloadHead()
        unloadHat()
        unloadGlasses()
    if not currTorso:
        loadTorso()
    destroyBackpackPlacer()
    loadBackpack()
    
def unloadBackpack():
    global currBackpack
    if not currBackpack:
        return
    currBackpack.removeNode()
    currBackpack = None

def clearBackpack():
    global currBackpack, currBackpackIndex

    if currBackpack is not None:
        currBackpackIndex = 0
        currBackpack.removeNode()
        currBackpack = None
        backpackLabel['text'] = 'Backpack: None'

def loadHat():
    global currHeadIndex, currHatIndex, currHat, hatLabel
    headSize = HeadSizes[currHeadIndex]
    print('loadHat', currHatIndex)
    if currHatIndex == 0:
        hatLabel['text'] = 'Hat: None'
        return
    modelName = HatModels[currHatIndex]
    hatLabel['text'] = 'Hat: ' + modelName
    currHat = loader.loadModel(modelName)
    try:
        pos, hpr, scale = data['hats']['specific'][str(currHatIndex)][headSize]
        print(pos, hpr, scale)
        currHat.setPos(*pos)
        currHat.setHpr(*hpr)
        currHat.setScale(*scale)
    except KeyError:
        try:
            pos, hpr, scale = data['hats']['defaults'][headSize]
            print(pos, hpr, scale)
            currHat.setPos(*pos)
            currHat.setHpr(*hpr)
            currHat.setScale(*scale)
        except KeyError:
            pass
    attachHat()

def attachHat():
    global currHat, currHead
    hatNode = currHead.attachNewNode('hatNode')
    currHat.reparentTo(hatNode)

def changeHat(offset):
    global currTorso, currHatIndex, currHatPlacer
    currHatIndex += offset
    
    if currHatIndex >= len(HatModels):
        currHatIndex = 0
    elif currHatIndex <= -1:
        currHatIndex = len(HatModels) - 1
    
    unloadHat()
    if currTorso is not None:
        unloadBackpack()
        unloadTorso()
    if not currHead:
        loadHead()
    destroyHatPlacer()
    loadHat()
    
def unloadHat():
    global currHat
    if not currHat:
        return
    currHat.removeNode()
    currHat = None

def clearHat():
    global currHat
    global currHatIndex

    if currHat is not None:
        currHatIndex = 0
        currHat.removeNode()
        currHat = None
        hatLabel['text'] = 'Hat: None'

def loadGlasses():
    global currHeadIndex, currGlassesIndex, currGlasses, glassesLabel
    headSize = HeadSizes[currHeadIndex]
    if currGlassesIndex == 0:
        glassesLabel['text'] = 'Glasses: None' 
        return
    modelName = GlassesModels[currGlassesIndex]
    glassesLabel['text'] = 'Glasses: ' + modelName
    currGlasses = loader.loadModel(modelName)
    try:
        pos, hpr, scale  = data['glasses']['specific'][str(currGlassesIndex)][headSize]
        currGlasses.setPos(*pos)
        currGlasses.setHpr(*hpr)
        currGlasses.setScale(*scale)
    except KeyError:
        print('Couldnt find poshprscale')
        try:
            pos, hpr, scale = data['glasses']['defaults'][headSize]
            currGlasses.setPos(*pos)
            currGlasses.setHpr(*hpr)
            currGlasses.setScale(*scale)
        except KeyError:
            pass
    attachGlasses()

def attachGlasses():
    global currGlasses, currHead
    glassesNode = currHead.attachNewNode('glassesNode')
    currGlasses.reparentTo(glassesNode)

def changeGlasses(offset):
    global currGlassesIndex, currGlassesPlacer
    currGlassesIndex += offset
    
    if currGlassesIndex >= len(GlassesModels):
        currGlassesIndex = 0
    elif currGlassesIndex <= -1:
        currGlassesIndex = len(GlassesModels) - 1

    unloadGlasses()
    if currTorso is not None:
        unloadBackpack()
        unloadTorso()
    if not currHead:
        loadHead()
    destroyGlassesPlacer()
    loadGlasses()

def unloadGlasses():
    global currGlasses
    if not currGlasses:
        return
    currGlasses.removeNode()
    currGlasses = None

def clearGlasses():
    global currGlasses
    global currGlassesIndex

    if currGlasses is not None:
        currHatIndex = 0
        currGlasses.removeNode()
        currHat = None
        hatLabel['text'] = 'Glasses: None'

def showLongHead(head):
    head.findAllMatches('**/*-short*').hide()
    head.findAllMatches('**/*_short*').hide()
    head.findAllMatches('**/muzzle-long-*').hide()
    head.ls()
    muzzle = head.find('**/muzzle-long-neutral')
    if muzzle and not muzzle.isEmpty():
        muzzle.show()
    else:
        muzzle = head.find('**/muzzle-short-neutral')
        muzzle.show()

def showShortHead(head):
    head.findAllMatches('**/*-long*').hide()
    head.findAllMatches('**/*_long*').hide()
    head.findAllMatches('**/muzzle-short-*').hide()
    head.ls()
    head.find('**/muzzle-short-neutral').show()
    
def showDogHead(head):
    head.ls()
    
def showTorso(torso):
    torso.ls()

def hashDict(d):
    return hash(json.dumps(d, sort_keys=True))

lastDataHash = None

def save():
    global lastDataHash, currHeadIndex, currTorsoIndex, currBackpack, currBackpackIndex, currGlasses, currGlassesIndex, currHat, currHatIndex
    headSize = HeadSizes[currHeadIndex]
    torsoSize = TorsoSizes[currTorsoIndex]
    
    if currBackpackIndex and currBackpack:
        pos, hpr, scale = list(round(i, 4) for i in currBackpack.getPos()), list(round(i, 4) for i in currBackpack.getHpr()), list(round(i, 4) for i in currBackpack.getScale())
        
        if str(currBackpackIndex) not in data['backpacks']['specific']:
            data['backpacks']['specific'][str(currBackpackIndex)] = dict()
        data['backpacks']['specific'][str(currBackpackIndex)][torsoSize] = [pos, hpr, scale]
    
    if currGlassesIndex and currGlasses:
        pos, hpr, scale = list(round(i, 4) for i in currGlasses.getPos()), list(round(i, 4) for i in currGlasses.getHpr()), list(round(i, 4) for i in currGlasses.getScale())
        
        if str(currGlassesIndex) not in data['glasses']['specific']:
            data['glasses']['specific'][str(currGlassesIndex)] = dict()
        data['glasses']['specific'][str(currGlassesIndex)][headSize] = [pos, hpr, scale]

    if currHatIndex and currHat:
        pos, hpr, scale = list(round(i, 4) for i in currHat.getPos()), list(round(i, 4) for i in currHat.getHpr()), list(round(i, 4) for i in currHat.getScale())
        if str(currHatIndex) not in data['hats']['specific']:
            data['hats']['specific'][str(currHatIndex)] = dict()
        data['hats']['specific'][str(currHatIndex)][headSize] = [pos, hpr, scale]

    dataHash = hashDict(data)

    if lastDataHash != dataHash:
        with open('accessories.json', 'w') as f:
            json.dump(data, f, sort_keys=True, indent=2, separators=(',', ': '))

        lastDataHash = dataHash

def __autosaveTask(task):
    save()
    return task.again

def autosave():
    if taskMgr.hasTaskNamed('autosave-task'):
        taskMgr.remove('autosave-task')
        autosaveButton['text'] = 'Autosave:\n\x01red\x01off\x02'
    else:
        save()
        taskMgr.doMethodLater(10, __autosaveTask, 'autosave-task')
        autosaveButton['text'] = 'Autosave:\n\x01green\x01on\x02'

from direct.gui.DirectGui import *
from panda3d.core import TextNode, TextProperties, TextPropertiesManager


DGG.setDefaultFont(loader.loadFont('phase_3/models/fonts/ImpressBT.ttf'))
DGG.setDefaultRolloverSound(loader.loadSfx('phase_3/audio/sfx/GUI_rollover.ogg'))
DGG.setDefaultClickSound(loader.loadSfx('phase_3/audio/sfx/GUI_create_toon_fwd.ogg'))
DGG.setDefaultDialogGeom(loader.loadModel('phase_3/models/gui/dialog_box_gui'))

red = TextProperties()
red.setTextColor(1, 0, 0, 1)
TextPropertiesManager.getGlobalPtr().setProperties('red', red)
green = TextProperties()
green.setTextColor(0, 1, 0, 1)
TextPropertiesManager.getGlobalPtr().setProperties('green', green)
yellow = TextProperties()
yellow.setTextColor(1, 1, 0, 1)

frame = DirectFrame(parent=base.a2dTopRight,relief=DGG.SUNKEN, borderWidth=(0.01, 0.01), frameSize=(-0.3, 0.3, -0.95, 0.3), pos=(-0.3, 0, -0.3))
nextHead = DirectButton(parent=frame, relief=2, text='Next Head', text_scale=0.04, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(0.15, 0, 0.2), command=changeHead, extraArgs=[1])
previousHead = DirectButton(parent=frame, relief=2, text='Prev Head', text_scale=0.04, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(-0.15, 0, 0.2), command=changeHead, extraArgs=[-1]) 
nextTorso = DirectButton(parent=frame, relief=2, text='Next Torso', text_scale=0.04, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(0.15, 0, 0.05), command=changeTorso, extraArgs=[1])
previousTorso = DirectButton(parent=frame, relief=2, text='Prev Torso', text_scale=0.04, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(-0.15, 0, 0.05), command=changeTorso, extraArgs=[-1])
nextBackpack = DirectButton(parent=frame, relief=2, text='Next Backpack', text_scale=0.030, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(0.15, 0, -0.10), command=changeBackpack, extraArgs=[1])
previousBackpack = DirectButton(parent=frame, relief=2, text='Prev Backpack', text_scale=0.030, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(-0.15, 0, -0.10), command=changeBackpack, extraArgs=[-1])
nextHat = DirectButton(parent=frame, relief=2, text='Next Hat', text_scale=0.04, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(0.15, 0, -0.25), command=changeHat, extraArgs=[1])
previousHat = DirectButton(parent=frame, relief=2, text='Prev Hat', text_scale=0.04, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(-0.15, 0, -0.25), command=changeHat, extraArgs=[-1])
nextGlasses = DirectButton(parent=frame, relief=2, text='Next Glasses', text_scale=0.035, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(0.15, 0, -0.40), command=changeGlasses, extraArgs=[1]) #delta +- 25
previousGlasses = DirectButton(parent=frame, relief=2, text='Prev Glasses', text_scale=0.035, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(-0.15, 0, -0.40), command=changeGlasses, extraArgs=[-1])
clearBackpack = DirectButton(parent=frame, relief=2, text='Clear Backpack', text_scale=0.030, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(-0.15, 0, -0.55), command=clearBackpack)
clearHat = DirectButton(parent=frame, relief=2, text='Clear Hat', text_scale=0.035, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(0.15, 0, -0.55), command=clearHat)
clearGlasses = DirectButton(parent=frame, relief=2, text='Clear Glasses', text_scale=0.035, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(-0.15, 0, -0.70), command=clearGlasses)
saveButton = DirectButton(parent=frame, relief=2, text='Save', text_scale=0.035, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), pos=(-0.15, 0, -0.85), command=save)
autosaveButton = DirectButton(parent=frame, relief=2, text='Autosave:\n\x01red\x01off\x02', text_scale=0.035, borderWidth=(0.01, 0.01), frameSize=(-0.1, 0.1, -0.05, 0.05), text_pos=(0, 0.01), pos=(0.15, 0, -0.85), command=autosave)

backpackLabel = DirectLabel(parent=base.a2dBottomCenter, relief=None, text='Backpack:', text_scale=0.05, pos=(0, 0, 0.1), text_align=TextNode.ACenter)
hatLabel = DirectLabel(parent=base.a2dBottomCenter, relief=None, text='Hat:', text_scale=0.05, pos=(0, 0, 0.2), text_align=TextNode.ACenter)
glassesLabel = DirectLabel(parent=base.a2dBottomCenter, relief=None, text='Glasses:', text_scale=0.05, pos=(0, 0, 0.3), text_align=TextNode.ACenter)

from PlacerTool3D import PlacerTool3D
from panda3d.core import Point3, Quat

def togglePlaceBackpack():
    global currBackpackPlacer
    if currBackpackPlacer:
        destroyBackpackPlacer()
    else:
        placeBackpack()

def placeBackpack():
    global currBackpack, currBackpackPlacer
    destroyBackpackPlacer()
    if currBackpack:
        currBackpackPlacer = PlacerTool3D(currBackpack)
    ignoreCameraKeys()

def destroyBackpackPlacer():
    global currBackpackPlacer
    if currBackpackPlacer:
        currBackpackPlacer.destroy()
        return

def togglePlaceHat():
    global currHatPlacer
    if currHatPlacer:
        destroyHatPlacer()
    else:
        placeHat()

def placeHat():
    global currHat, currHatPlacer
    destroyHatPlacer()
    if currHat:
        currHatPlacer = PlacerTool3D(currHat)
    ignoreCameraKeys()

def destroyHatPlacer():
    global currHatPlacer
    if currHatPlacer:
        currHatPlacer.destroy()
        return

def togglePlaceGlasses():
    global currGlasses, currGlassesPlacer
    if currGlassesPlacer:
        destroyGlassesPlacer()
    else:
        placeGlasses()        

def placeGlasses():
    global currGlasses, currGlassesPlacer
    destroyGlassesPlacer()
    if currGlasses:
        currGlassesPlacer = PlacerTool3D(currGlasses)
    ignoreCameraKeys()

def destroyGlassesPlacer():
    global currGlassesPlacer
    if currGlassesPlacer:
        currGlassesPlacer.destroy()
        return

cameraLerps = [
    (Point3(0, 5, 0), Point3(180, 0, 0),),
    (Point3(-5, 0, 0), Point3(270, 0, 0),),
    (Point3(0, -5, 0), Point3(0, 0, 0),),
    (Point3(5, 0, 0), Point3(90, 0, 0),),
]

def cameraLerp(i):
    pos, hpr = cameraLerps[i]
    quat = Quat()
    quat.setHpr(hpr)
    camera.posQuatInterval(1.2, pos, quat).start()


base.accept('b', togglePlaceBackpack)
base.accept('h', togglePlaceHat)
base.accept('g', togglePlaceGlasses)
base.accept('o', base.oobe)

def acceptCameraKeys():

    base.accept('1', lambda: cameraLerp(0))
    base.accept('2', lambda: cameraLerp(1))
    base.accept('3', lambda: cameraLerp(2))
    base.accept('4', lambda: cameraLerp(3))

def ignoreCameraKeys():
    base.ignore('1')
    base.ignore('2')
    base.ignore('3')
    base.ignore('4')

def onPlacerDestroy(placer):
    global currBackpackPlacer, currGlassesPlacer, currHatPlacer
    if placer == currBackpackPlacer:
        currBackpackPlacer = None
    if placer == currHatPlacer:
        currHatPlacer = None
    if placer == currGlassesPlacer:
        currGlassesPlacer = None
    
    if not currBackpackPlacer and not currGlassesPlacer and not currHatPlacer:
        acceptCameraKeys()

base.accept('placer-destroyed', onPlacerDestroy)
backpackLabel['text'] = 'Backpack: None'
hatLabel['text'] = 'Hat: None'
glassesLabel['text'] = 'Glasses: None'
loadHead()
camera.setPosHpr(0, 5, 0, 180, 0, 0)
acceptCameraKeys()
base.disableMouse()
try:
    base.run()
except:
    save()